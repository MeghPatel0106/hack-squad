{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Manage Technicians</h1>
    <button onclick="openModal()" class="btn-primary-glow"><i class="fa-solid fa-plus"></i> New Technician</button>
</div>

<div class="glass-card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Avatar</th>
                    <th>Name</th>
                    <th>Team</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tech-list"></tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div id="techModal" class="modal-overlay" style="display: none;">
    <div class="glass-card modal-content" style="max-width: 500px;">
        <h2>Add Technician</h2>
        <form onsubmit="createTechnician(event)">
            <div class="form-group">
                <label>Name</label>
                <input type="text" name="name" required>
            </div>
            <div class="form-group">
                <label>Email (Login)</label>
                <input type="email" name="email" required placeholder="tech@mechcare.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" name="password" required placeholder="******">
            </div>
            <div class="form-group">
                <label>Team</label>
                <select name="team_id" id="teamSelectModal">
                    <option value="">No Team</option>
                </select>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" onclick="closeModal()" class="btn-outline">Cancel</button>
                <button type="submit" class="btn-primary-glow">Create</button>
            </div>
        </form>
    </div>
</div>

<script>
    async function loadData() {
        const [techRes, teamRes] = await Promise.all([
            fetch('/api/technicians'),
            fetch('/api/teams')
        ]);

        const techs = await techRes.json();
        const teams = await teamRes.json();

        // Populate Team Select
        const teamSelect = document.getElementById('teamSelectModal');
        teamSelect.innerHTML = '<option value="">No Team</option>' +
            teams.map(t => `<option value="${t.id}">${t.team_name}</option>`).join('');

        // Populate Table
        const list = document.getElementById('tech-list');
        list.innerHTML = techs.map(t => `
            <tr>
                <td><img src="${t.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + t.name}" style="width:32px;height:32px;border-radius:50%"></td>
                <td>${t.name}</td>
                <td><span class="card-tag">${t.team_name || 'Unassigned'}</span></td>
                <td>${t.role}</td>
                <td>
                    <button onclick="deleteTech(${t.id})" style="color: var(--danger); background: none; border: none; cursor: pointer;">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    async function createTechnician(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        const res = await fetch('/api/technicians', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            closeModal();
            loadData();
            e.target.reset();
        } else {
            alert('Error creating technician');
        }
    }

    async function deleteTech(id) {
        if (!confirm('Delete technician?')) return;
        await fetch(`/api/technicians/${id}`, { method: 'DELETE' });
        loadData();
    }

    function openModal() { document.getElementById('techModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('techModal').style.display = 'none'; }

    document.addEventListener('DOMContentLoaded', loadData);
</script>

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
</style>
{% endblock %}